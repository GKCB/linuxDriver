

### 第005节 [字符设备驱动程序之查询方式的按键驱动程序](#字符设备驱动程序之查询方式的按键驱动程序)  


#### 字符设备驱动程序之查询方式的按键驱动程序
实现目的：以查询方式查看按键是否被按下  

1. 写出框架  
可以参照已有的c.json文档  

2. 配置寄存器，也就是硬件操作  
查看先关的原理图，确定是那些寄存器，引脚。  
查看外部的设备GPF0,GPF2,GPG3

![按键原理图](./image/005/按键原理图.png)  

使用查询意味着把它们设置为输入方式：  
包含在寄存器GPFCON和GPFDAT中。  

open函数中初始化寄存器。

```c{.lines-numbers}
//set regs
*gpfcon &= ~((0x3<<4) | (0x3<<0));
*gpgcon &= ~((0x3<<(3*2)) | (0x3<<(11*2)));
```
read函数读取寄存器的值    
```
//read regs
unsigned char key_vals[4];
int regval;
if (size != sizeof(key_vals))
    return -EINVAL;
/* 读GPF0,2 */
regval = *gpfdat;
key_vals[0] = (regval & (1<<0)) ? 1 : 0;
key_vals[1] = (regval & (1<<2)) ? 1 : 0;

/* 读GPG3,11 */
regval = *gpgdat;
key_vals[2] = (regval & (1<<3)) ? 1 : 0;
key_vals[3] = (regval & (1<<11)) ? 1 : 0;

copy_to_user(buf, key_vals, sizeof(key_vals));
```

加入中断处理方式  
